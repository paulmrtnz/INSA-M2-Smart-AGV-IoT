#include "LEDMatrix.h"

// --- Static Member Definitions ---

const byte LEDMatrix::smilePattern[16]  = { 0x00, 0x00, 0x10, 0x20, 0x40, 0x40, 0x4c, 0x40, 0x40, 0x4c, 0x40, 0x40, 0x20, 0x10, 0x00, 0x00 };
const byte LEDMatrix::PGPLogo[16]       = { 0x08, 0x2a, 0x2a, 0x7e, 0x12, 0x12, 0x0c, 0x3c, 0x42, 0x52, 0x30, 0x7e, 0x12, 0x12, 0x0c, 0x00 };
const byte LEDMatrix::fullPattern[16]   = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
const byte LEDMatrix::warningPattern[16]= { 0x00, 0x00, 0x00, 0x5e, 0x5e, 0x00, 0x00, 0x5e, 0x5e, 0x00, 0x00, 0x5e, 0x5e, 0x00, 0x00, 0x00 };

const byte LEDMatrix::font5x8[][5] = {
  {0x7E, 0x11, 0x11, 0x11, 0x7E}, // A
  {0x7F, 0x49, 0x49, 0x49, 0x36}, // B
  {0x3E, 0x41, 0x41, 0x41, 0x22}, // C
  {0x7F, 0x41, 0x41, 0x41, 0x3E}, // D
  {0x7F, 0x49, 0x49, 0x49, 0x41}, // E
  {0x7F, 0x09, 0x09, 0x09, 0x01}, // F
  {0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
  {0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
  {0x00, 0x41, 0x7F, 0x41, 0x00}, // I
  {0x20, 0x40, 0x41, 0x3F, 0x01}, // J
  {0x7F, 0x08, 0x14, 0x22, 0x41}, // K
  {0x7F, 0x40, 0x40, 0x40, 0x40}, // L
  {0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
  {0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
  {0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
  {0x7F, 0x09, 0x09, 0x09, 0x06}, // P
  {0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
  {0x7F, 0x09, 0x19, 0x29, 0x46}, // R
  {0x46, 0x49, 0x49, 0x49, 0x31}, // S
  {0x01, 0x01, 0x7F, 0x01, 0x01}, // T
  {0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
  {0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
  {0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
  {0x63, 0x14, 0x08, 0x14, 0x63}, // X
  {0x07, 0x08, 0x70, 0x08, 0x07}, // Y
  {0x61, 0x51, 0x49, 0x45, 0x43}, // Z
  {0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
  {0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
  {0x42, 0x61, 0x51, 0x49, 0x46}, // 2
  {0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
  {0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
  {0x27, 0x45, 0x45, 0x45, 0x39}, // 5
  {0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
  {0x01, 0x71, 0x09, 0x05, 0x03}, // 7
  {0x36, 0x49, 0x49, 0x49, 0x36}, // 8
  {0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
  {0x00, 0x00, 0x00, 0x00, 0x00}  // Space
};

// --- Class Methods ---

LEDMatrix::LEDMatrix(int sclPin, int sdaPin) : _sclPin(sclPin), _sdaPin(sdaPin) {}

void LEDMatrix::setup() {
    pinMode(_sclPin, OUTPUT);
    pinMode(_sdaPin, OUTPUT);
    clear();
}

void LEDMatrix::displayPattern(const byte pattern[16]) {
    IIC_start();
    IIC_send(0xc0); // Address command

    for (int i = 0; i < 16; i++) {
        IIC_send(pattern[i]);
    }

    IIC_end();

    IIC_start();
    IIC_send(0x8A); // Display ON command
    IIC_end();
}

void LEDMatrix::clear() {
    byte clearData[16] = {0};
    displayPattern(clearData);
}

int LEDMatrix::getFontIndex(char c) {
    if (c >= 'A' && c <= 'Z') return c - 'A';
    if (c >= 'a' && c <= 'z') return c - 'a';
    if (c >= '0' && c <= '9') return 26 + (c - '0');
    return 36; // Space character
}

void LEDMatrix::scrollTextBlocking(const String& text, int scrollSpeed) {
    int textLength = text.length();
    if (textLength == 0) return;
    
    int totalWidth = textLength * 6;
    byte* buffer = new byte[totalWidth];

    for (int i = 0; i < textLength; i++) {
        int fontIdx = getFontIndex(text[i]);
        for (int col = 0; col < 5; col++) {
            buffer[i * 6 + col] = font5x8[fontIdx][col];
        }
        buffer[i * 6 + 5] = 0x00; // 1-pixel space between chars
    }

    for (int offset = -16; offset < totalWidth; offset++) {
        byte displayBuffer[16] = {0};
        for (int i = 0; i < 16; i++) {
            int textPos = offset + i;
            if (textPos >= 0 && textPos < totalWidth) {
                displayBuffer[i] = buffer[textPos];
            }
        }
        displayPattern(displayBuffer);
        delay(scrollSpeed);
    }

    delete[] buffer;
    clear();
}


// --- Private I2C-like methods ---

void LEDMatrix::IIC_start() {
    digitalWrite(_sdaPin, HIGH);
    digitalWrite(_sclPin, HIGH);
    delayMicroseconds(3);
    digitalWrite(_sdaPin, LOW);
    delayMicroseconds(3);
    digitalWrite(_sclPin, LOW);
}

void LEDMatrix::IIC_end() {
    digitalWrite(_sclPin, LOW);
    digitalWrite(_sdaPin, LOW);
    delayMicroseconds(3);
    digitalWrite(_sclPin, HIGH);
    delayMicroseconds(3);
    digitalWrite(_sdaPin, HIGH);
    delayMicroseconds(3);
}

void LEDMatrix::IIC_send(byte send_data) {
    for (byte mask = 0x01; mask != 0; mask <<= 1) {
        digitalWrite(_sdaPin, (send_data & mask) ? HIGH : LOW);
        delayMicroseconds(3);
        digitalWrite(_sclPin, HIGH);
        delayMicroseconds(3);
        digitalWrite(_sclPin, LOW);
    }
}
